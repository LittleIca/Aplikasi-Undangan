<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Pembuat Undangan WhatsApp</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM CDNs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Lucide React Icons CDN -->
  <script type="module">
    import { createElement } from 'react';
    import { Clipboard, Save, Trash, Edit2, Copy, Users, Calendar, Clock, MapPin, MessageCircle, X, Plus, Link, Signature, Notebook, CheckCircle, Upload, Download, AlertTriangle } from 'https://cdn.jsdelivr.net/npm/lucide-react@latest/dist/esm/lucide-react.mjs';
    window.lucide = { Clipboard, Save, Trash, Edit2, Copy, Users, Calendar, Clock, MapPin, MessageCircle, X, Plus, Link, Signature, Notebook, CheckCircle, Upload, Download, AlertTriangle };
  </script>
  <!-- Firebase CDNs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    window.firebase = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query };
  </script>
  <!-- XLSX CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query } = window.firebase;

    // Fungsi utilitas untuk menyalin teks ke clipboard
    const copyToClipboard = (text) => {
      const el = document.createElement('textarea');
      el.value = text;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
    };

    const App = () => {
      const [userId, setUserId] = useState(null);
      const [invitations, setInvitations] = useState([]);
      const [isAuthReady, setIsAuthReady] = useState(false);
      const [formData, setFormData] = useState({
        recipientName: '',
        eventName: '',
        eventDate: '',
        eventDay: '',
        eventTime: '',
        eventLocation: '',
        mapsLink: '',
        notes: '',
        signature: ''
      });
      const [currentEditingId, setCurrentEditingId] = useState(null);
      const [showModal, setShowModal] = useState(false);
      const [modalText, setModalText] = useState('');
      const [modalType, setModalType] = useState('success');
      const [authError, setAuthError] = useState(null);
      const fileInputRef = useRef(null);
      
      const { Clipboard, Save, Trash, Edit2, Copy, Users, Calendar, Clock, MapPin, MessageCircle, X, Plus, Link, Signature, Notebook, CheckCircle, Upload, Download, AlertTriangle } = window.lucide;
      
      const firebaseConfig = {
        apiKey: "AIzaSyA_dK8niW70OypyAdWNJQzUB3kAm4tLYDw",
        authDomain: "surat-b2caa.firebaseapp.com",
        projectId: "surat-b2caa",
        storageBucket: "surat-b2caa.firebasestorage.app",
        messagingSenderId: "346909336642",
        appId: "1:346909336642:web:6148cca658063dddc4f9db",
        measurementId: "G-JJN7GLMWV0"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const appId = firebaseConfig.projectId;
      const collectionPath = `/artifacts/${appId}/public/data/invitations`;
      const dayNames = ['Ahad', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

      // Menangani perubahan input formulir dan menghitung hari secara otomatis
      const handleInputChange = (e) => {
        const { name, value } = e.target;
        let updatedFormData = { ...formData, [name]: value };

        if (name === 'eventDate' && value) {
          try {
            const date = new Date(value);
            const dayIndex = date.getDay();
            const day = dayNames[dayIndex];
            updatedFormData = { ...updatedFormData, eventDay: day };
          } catch (error) {
            console.error("Invalid date selected:", error);
            updatedFormData = { ...updatedFormData, eventDay: '' };
          }
        }

        setFormData(updatedFormData);
      };

      // Menampilkan pesan modal
      const showMessage = (text, type = 'success') => {
        setModalText(text);
        setModalType(type);
        setShowModal(true);
        setTimeout(() => {
          setShowModal(false);
        }, 3000);
      };

      // Menghasilkan teks undangan lengkap dari objek data yang diberikan
      const generateInvitationText = (data) => {
        const { recipientName, eventName, eventDate, eventDay, eventTime, eventLocation, mapsLink, notes, signature } = data;
        let text = `*ðŸ“©Hal : UNDANGAN*\n\n`;
        text += `*_Assalamu'alaikum Warahmatullahi Wabarakatuh_*\n\n`;

        if (recipientName) {
          text += `Dimohon kehadiran ${recipientName} pada :\n\n`;
        } else {
          text += `Dimohon kehadiran pada :\n\n`;
        }

        text += `ðŸ“Œ Hari        : ${eventDay}\n`;
        const formattedDate = eventDate ? new Date(eventDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '';
        text += `ðŸ“… Tanggal : ${formattedDate}\n`;
        text += `â° Waktu    : ${eventTime ? `${eventTime} WIB` : ''}\n`;
        text += `ðŸ“’ Acara     : ${eventName}\n`;
        text += `ðŸ¡ Tempat  : ${eventLocation}\n`;
        
        if (mapsLink) {
            text += `${mapsLink}\n\n`;
        } else {
            text += '\n';
        }

        text += `Demikian undangan ini kami sampaikan, atas perhatian dan kehadirannya kami ucapkan terimakasih.\n\n`;
        text += `*_Wassalamu'alaikum Warahmatullahi Wabarakatuh_*\n\n`;
        
        if (notes) {
          text += `NB: ${notes}\n\n`;
        }
        
        text += `TTD\n`;
        text += `_${signature}_`;

        return text;
      };

      // Teks undangan untuk pratinjau langsung (menggunakan formData dari state)
      const invitationText = generateInvitationText(formData);
      
      // Menangani otentikasi Firebase saat aplikasi dimuat
      useEffect(() => {
        signInAnonymously(auth)
          .then((userCredential) => {
            setUserId(userCredential.user.uid);
            setIsAuthReady(true);
          })
          .catch((error) => {
            console.error("Authentication failed:", error);
            setAuthError('Gagal terhubung ke Firebase Authentication.');
            setUserId(crypto.randomUUID());
            setIsAuthReady(true);
          });
      }, []);

      // Mendengarkan perubahan data di koleksi Firestore secara real-time
      useEffect(() => {
        if (!isAuthReady || authError) {
          return;
        }

        const q = query(collection(db, collectionPath));
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
          const savedInvitations = querySnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setInvitations(savedInvitations);
        }, (error) => {
          console.error("Error fetching invitations:", error);
          showMessage('Gagal memuat undangan. Periksa kembali aturan keamanan Firestore Anda.', 'error');
        });

        return () => unsubscribe();
      }, [isAuthReady, collectionPath, authError]);

      // Menyimpan atau memperbarui undangan di Firestore
      const handleSave = async () => {
        if (!isAuthReady || !collectionPath) {
          showMessage('Otentikasi belum siap. Silakan coba lagi.', 'error');
          return;
        }
        
        if (!formData.eventName || !formData.eventDate || !formData.eventTime || !formData.eventLocation || !formData.eventDay || !formData.signature) {
          showMessage('Semua kolom acara dan tanda tangan harus diisi!', 'error');
          return;
        }
        
        if (authError) {
          showMessage(authError, 'error');
          return;
        }

        try {
          if (currentEditingId) {
            await updateDoc(doc(db, collectionPath, currentEditingId), {
              ...formData,
              createdAt: new Date().toISOString()
            });
            showMessage('Undangan berhasil diperbarui!', 'success');
            setCurrentEditingId(null);
          } else {
            await addDoc(collection(db, collectionPath), {
              ...formData,
              createdAt: new Date().toISOString()
            });
            showMessage('Undangan berhasil disimpan!', 'success');
          }
          handleClearForm();
        } catch (e) {
          console.error("Error saving invitation:", e);
          showMessage('Gagal menyimpan undangan. Silakan coba lagi. Pastikan aturan keamanan Firestore sudah benar.', 'error');
        }
      };

      // Menghapus undangan dari Firestore
      const handleDelete = async (id) => {
        if (!isAuthReady || !collectionPath || authError) {
          showMessage('Otentikasi belum siap. Silakan coba lagi.', 'error');
          return;
        }
        try {
          await deleteDoc(doc(db, collectionPath, id));
          showMessage('Undangan berhasil dihapus!', 'success');
        } catch (e) {
          console.error("Error deleting invitation:", e);
          showMessage('Gagal menghapus undangan. Silakan coba lagi. Pastikan aturan keamanan Firestore sudah benar.', 'error');
        }
      };

      // Menduplikasi undangan ke Firestore
      const handleDuplicate = async (invitation) => {
        if (!isAuthReady || !collectionPath || authError) {
          showMessage('Otentikasi belum siap. Silakan coba lagi.', 'error');
          return;
        }
        try {
          const { id, ...invitationToDuplicate } = invitation;
          await addDoc(collection(db, collectionPath), {
            ...invitationToDuplicate,
            createdAt: new Date().toISOString()
          });
          showMessage('Undangan berhasil diduplikasi!', 'success');
        } catch (e) {
          console.error("Error duplicating invitation:", e);
          showMessage('Gagal menduplikasi undangan. Silakan coba lagi. Pastikan aturan keamanan Firestore sudah benar.', 'error');
        }
      };

      // Menyalin teks undangan spesifik dari rekap
      const handleCopySpecificInvitation = (invitation) => {
        const text = generateInvitationText(invitation);
        copyToClipboard(text);
        showMessage('Teks undangan berhasil disalin!', 'success');
      };

      // Memuat undangan ke dalam formulir untuk diedit
      const handleEdit = (invitation) => {
        setFormData({
          recipientName: invitation.recipientName || '',
          eventName: invitation.eventName || '',
          eventDate: invitation.eventDate || '',
          eventDay: invitation.eventDay || '',
          eventTime: invitation.eventTime || '',
          eventLocation: invitation.eventLocation || '',
          mapsLink: invitation.mapsLink || '',
          notes: invitation.notes || '',
          signature: invitation.signature || ''
        });
        setCurrentEditingId(invitation.id);
      };

      // Membersihkan formulir
      const handleClearForm = () => {
        setFormData({
          recipientName: '',
          eventName: '',
          eventDate: '',
          eventDay: '',
          eventTime: '',
          eventLocation: '',
          mapsLink: '',
          notes: '',
          signature: ''
        });
        setCurrentEditingId(null);
      };

      // Menyalin teks undangan ke clipboard (tombol utama di formulir)
      const handleCopy = () => {
        copyToClipboard(invitationText);
        showMessage('Teks undangan berhasil disalin!', 'success');
      };

      // Mengekspor data ke XLSX
      const handleExport = () => {
        try {
          if (typeof XLSX === 'undefined') {
            showMessage('Pustaka XLSX belum dimuat. Silakan coba lagi.', 'error');
            return;
          }
          const dataToExport = invitations.map(({ id, ...rest }) => rest);
          const worksheet = XLSX.utils.json_to_sheet(dataToExport);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Undangan");
          const date = new Date().toISOString().slice(0, 10);
          XLSX.writeFile(workbook, `Undangan_Tanggal_${date}.xlsx`);
          showMessage('Data berhasil diekspor!', 'success');
        } catch (e) {
          console.error("Error exporting data:", e);
          showMessage('Gagal mengekspor data. Silakan coba lagi.', 'error');
        }
      };

      // Mengimpor data dari XLSX
      const handleImport = (event) => {
        try {
          if (typeof XLSX === 'undefined') {
            showMessage('Pustaka XLSX belum dimuat. Silakan coba lagi.', 'error');
            return;
          }
          const file = event.target.files[0];
          if (!file) {
            return;
          }

          const reader = new FileReader();
          reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            // Menambahkan setiap undangan yang diimpor ke Firestore
            for (const item of json) {
              await addDoc(collection(db, collectionPath), {
                ...item,
                createdAt: new Date().toISOString()
              });
            }
            showMessage('Data berhasil diimpor!', 'success');
          };
          reader.readAsArrayBuffer(file);
        } catch (e) {
          console.error("Error importing data:", e);
          showMessage('Gagal mengimpor data. Silakan coba lagi.', 'error');
        }
      };

      const ModalMessage = ({ text, type }) => (
        <div className={`fixed top-4 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${showModal ? 'opacity-100 scale-100' : 'opacity-0 scale-90'} ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}>
          <div className="flex items-center gap-2">
            {type === 'success' ? <CheckCircle size={20} /> : <X size={20} />}
            <span>{text}</span>
          </div>
        </div>
      );

      return (
        <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans antialiased text-gray-800">
          <ModalMessage text={modalText} type={modalType} />
          
          <header className="max-w-7xl mx-auto mb-8 bg-white rounded-2xl shadow-lg p-4">
            <h1 className="text-3xl font-extrabold text-center text-teal-600 mb-4">Aplikasi Pembuat Undangan</h1>
            <p className="text-center text-sm text-gray-500">ID Pengguna (untuk debug): {userId}</p>
          </header>
          
          <div className="max-w-4xl mx-auto space-y-8">
            
            {/* Formulir dan Pratinjau */}
            <div className="bg-white rounded-2xl shadow-xl p-6 flex flex-col gap-6">
              <h2 className="text-2xl font-bold text-center text-teal-600">Isi Detail Undangan</h2>
              {authError && (
                  <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg flex items-center gap-3">
                      <AlertTriangle size={24} className="flex-shrink-0" />
                      <p className="text-sm font-medium">{authError}</p>
                  </div>
              )}
              <div className="flex flex-col gap-4">
                <div className="space-y-4">
                  <div className="relative">
                    <input
                      type="text"
                      name="recipientName"
                      placeholder="Nama Penerima (contoh: John Doe)"
                      value={formData.recipientName}
                      onChange={handleInputChange}
                      className="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-teal-400 transition duration-300"
                    />
                    <Users className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                  </div>
                  <div className="relative">
                    <input
                      type="text"
                      name="eventName"
                      placeholder="Nama Acara (contoh: Rapat Bulanan PH)"
                      value={formData.eventName}
                      onChange={handleInputChange}
                      className="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-teal-400 transition duration-300"
                    />
                    <Notebook className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                  </div>
                  <div className="flex flex-col md:flex-row gap-4">
                    <div className="relative w-full">
                      <input
                        type="text"
                        name="eventDay"
                        placeholder="Hari"
                        value={formData.eventDay}
                        readOnly
                        className="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed transition duration-300"
                      />
                      <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                    </div>
                    <div className="relative w-full">
                      <input
                        type="date"
                        name="eventDate"
                        value={formData.eventDate}
                        onChange={handleInputChange}
                        className="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-teal-400 transition duration-300"
                      />
                      <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                    </div>
                  </div>
                  <div className="flex flex-col md:flex-row gap-4">
                    <div className="relative w-full">
                      <input
                        type="text"
                        name="eventTime"
                        placeholder="Waktu (contoh: 18.15)"
                        value={formData.eventTime}
                        onChange={handleInputChange}
                        className="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-teal-400 transition duration-300"
                      />
                      <Clock className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                    </div>
                    <div className="relative w-full">
                      <input
                        type="text"
                        name="eventLocation"
                        placeholder="Tempat Acara"
                        value={formData.eventLoc
